# **Aula - Pipeline de Agrega√ß√£o**
> Nesta aula, estudaremos como utilizar os principais est√°gios do pipeline para manipular dados de maneira eficiente.
> 
> O **MongoDB** √© um banco de dados **NoSQL**, muito utilizado para armazenar dados n√£o estruturados ou semi-estruturados, como documentos JSON. O **pipeline de agrega√ß√£o** √© uma das funcionalidades mais poderosas do MongoDB, permitindo que voc√™s realizem opera√ß√µes avan√ßadas de an√°lise e transforma√ß√£o de dados diretamente no servidor.
>
> ---
> 

## :one: **Introdu√ß√£o ao Banco de Dados mflix**

O **mflix** √© um conjunto de dados fict√≠cio do MongoDB, inspirado em uma plataforma de streaming (como o Netflix), e √© muito utilizado para fins did√°ticos. Ele cont√©m informa√ß√µes sobre **filmes, atores, diretores, g√™neros, coment√°rios** e muito mais.

Nesta aula pr√°tica, vamos utilizar o banco de dados **mflix** para explorar as boas pr√°ticas no uso do **Pipeline de Agrega√ß√£o** no **MongoDB Atlas**. Voc√™ aprender√° a filtrar, agrupar, projetar e ordenar dados de maneira eficiente, utilizando exemplos reais e comandos bem explicados.


## :two: **Introdu√ß√£o ao Pipeline de Agrega√ß√£o**

### üìå O que √© o Pipeline de Agrega√ß√£o?

O **pipeline de agrega√ß√£o** no MongoDB √© uma sequ√™ncia de est√°gios (`stages`) que processam documentos da cole√ß√£o, transformando-os conforme necessidade. Cada est√°gio realiza uma opera√ß√£o espec√≠fica, como:

- Filtragem
- Agrupamento
- Proje√ß√£o
- Ordena√ß√£o
- Limita√ß√£o

### üîÅ Funcionamento do Pipeline

Os documentos entram no primeiro est√°gio do pipeline e passam por todos os est√°gios em sequ√™ncia at√© serem retornados como resultado final.

```
Cole√ß√£o ‚Üí [ $match ] ‚Üí [ $group ] ‚Üí [ $project ] ‚Üí Resultado Final
```

### ‚úÖ Vantagens do Pipeline de Agrega√ß√£o

- Processamento em tempo real no servidor.
- Redu√ß√£o da carga na aplica√ß√£o.
- Facilidade de criar relat√≥rios e an√°lises complexas.
- Suporte a fun√ß√µes matem√°ticas, l√≥gicas e manipula√ß√£o de strings.

---

## :three: **Principais Est√°gios do Pipeline**

Vamos conhecer os principais est√°gios do **pipeline de agrega√ß√£o** usando o banco **mflix**, com base na cole√ß√£o `movies`.

---

### **a) `$match` ‚Äì Filtrar Documentos**

**Filtra** os documentos **antes** que sejam **processados** pelos pr√≥ximos est√°gios.

```javascript
{
  $match: { campo: valor }
}
```

**Exemplo: Mostrar apenas filmes com nota maior que 7**
```javascript
db.movies.aggregate([
  { $match: { "imdb.rating": { $gt: 7 } } }
])
```

Este exemplo retorna filmes com avalia√ß√£o IMDb maior que 7.

---

### **b) `$group` ‚Äì Agrupar Dados**

**Agrupa** documentos **com base** em um ou mais **campos**. √ötil para c√°lculos como **m√©dia, soma, contagem**, etc.

```javascript
{
  $group: {
    _id: campo_de_grupo,
    nome_da_saida: { $aggregationOperator: "$campo" }
  }
}
```

**Operadores comuns:**
- `$sum`: Soma
- `$avg`: M√©dia
- `$max`: M√°ximo
- `$min`: M√≠nimo
- `$count`: Contagem

**Exemplo: Contar quantos filmes existem por g√™nero**
```javascript
db.movies.aggregate([
  { $unwind: "$genres" },
  {
    $group: {
      _id: "$genres",
      total_filmes: { $sum: 1 }
    }
  }
])
```

**Sa√≠da**:

```js
[
  { _id: 'Action', total_filmes: 2381 },
  { _id: 'Romance', total_filmes: 3318 },
  { _id: 'Adventure', total_filmes: 1900 },
  { _id: 'Crime', total_filmes: 2457 },
  { _id: 'Documentary', total_filmes: 1834 },
  { _id: 'Horror', total_filmes: 1470 },
  { _id: 'Talk-Show', total_filmes: 1 },
  { _id: 'Drama', total_filmes: 12385 },
  { _id: 'Thriller', total_filmes: 2454 },
  { _id: 'Sci-Fi', total_filmes: 958 },
  { _id: 'Family', total_filmes: 1249 },
  { _id: 'Western', total_filmes: 242 },
  { _id: 'Comedy', total_filmes: 6532 },
  { _id: 'Fantasy', total_filmes: 1055 },
  { _id: 'Biography', total_filmes: 1269 },
  { _id: 'Mystery', total_filmes: 1139 },
  { _id: 'War', total_filmes: 699 },
  { _id: 'Animation', total_filmes: 912 },
  { _id: 'News', total_filmes: 44 },
  { _id: 'Short', total_filmes: 442 }
]
```

Este exemplo conta a quantidade de filmes por g√™nero. Usamos `$unwind` para **desmembrar o array** de g√™neros.


### **c) `$project` ‚Äì Projetar Campos**

Permite **incluir, excluir ou renomear campos** nos resultados finais.

```javascript
{
  $project: {
    campo_incluir: 1,
    campo_excluir: 0,
    novo_nome: "$velho_nome"
  }
}
```

**Exemplo: Exibir apenas t√≠tulo e ano do filme**
```javascript
db.movies.aggregate([
  {
    $project: {
      title: 1,
      year: 1,
      _id: 0
    }
  }
])
```

Este exemplo projeta apenas os campos `title` e `year`, excluindo o `_id`.

---

### **d) `$sort` ‚Äì Ordenar Resultados**

Ordena os documentos com base em um ou mais campos.

```javascript
{
  $sort: { campo: 1 ou -1 }
}
```

- `1`: Crescente
- `-1`: Decrescente

**Exemplo: Listar filmes com melhor nota, do maior para o menor**
```javascript
db.movies.aggregate([
  { $match: { "imdb.rating": { $exists: true } } },
  { $sort: { "imdb.rating": -1 } },
  { $limit: 5 }
])
```

Este exemplo **mostra os 5 filmes** com a maior avalia√ß√£o IMDb.

---

### **e) `$limit` ‚Äì Limitar N√∫mero de Resultados**

Restringe a **quantidade de documentos retornados** pelo pipeline.

```javascript
{
  $limit: numero
}
```

**J√° usado no exemplo acima:** limita a 5 filmes.

---

## :four: **Exemplos Pr√°ticos com o Banco mflix**

Agora vamos juntar os est√°gios para resolver problemas reais com o banco de dados `mflix`.

Selecionando a cole√ß√£o `sample_mflix`

```js
use sample_mflix
```

**Sa√≠da**:


```js
switched to db sample_mflix
```

### üéØ Exemplo 1: Total de Filmes por G√™nero

**üí° Objetivo:**
- Mostrar a quantidade de filmes por g√™nero.

**‚úÖ Solu√ß√£o:**
```javascript
db.movies.aggregate([
  { $unwind: "$genres" },
  {
    $group: {
      _id: "$genres",
      total_filmes: { $sum: 1 }
    }
  },
  { $sort: { total_filmes: -1 } },
  { $limit: 10 }
])
```


**Sa√≠da**:
```js
[
  { _id: 'Drama', total_filmes: 12385 },
  { _id: 'Comedy', total_filmes: 6532 },
  { _id: 'Romance', total_filmes: 3318 },
  { _id: 'Crime', total_filmes: 2457 },
  { _id: 'Thriller', total_filmes: 2454 },
  { _id: 'Action', total_filmes: 2381 },
  { _id: 'Adventure', total_filmes: 1900 },
  { _id: 'Documentary', total_filmes: 1834 },
  { _id: 'Horror', total_filmes: 1470 },
  { _id: 'Biography', total_filmes: 1269 }
]
```


**üìù Explica√ß√£o:**

1. `$unwind`: Desfaz o array de g√™neros (`genres`).
2. `$group`: Agrupa por g√™nero e conta a quantidade de filmes.
3. `$sort`: Ordena os g√™neros pelo n√∫mero de filmes em ordem decrescente.
4. `$limit`: Mostra apenas os 10 g√™neros mais populares.

### üéØ Exemplo 2: Top 5 Diretores com Mais Filmes

 **üí° Objetivo**:
- Listar os 5 diretores que possuem mais filmes no banco de dados.

 **‚úÖ Solu√ß√£o:**
```javascript
db.movies.aggregate([
  { $unwind: "$directors" },
  {
    $group: {
      _id: "$directors",
      total_filmes: { $sum: 1 }
    }
  },
  { $sort: { total_filmes: -1 } },
  { $limit: 5 },
  {
    $project: {
      diretor: "$_id",
      total_filmes: 1,
      _id: 0
    }
  }
])
```

**Sa√≠da**:
```js
[
  { total_filmes: 40, diretor: 'Woody Allen' },
  { total_filmes: 32, diretor: 'Martin Scorsese' },
  { total_filmes: 31, diretor: 'Takashi Miike' },
  { total_filmes: 29, diretor: 'Sidney Lumet' },
  { total_filmes: 29, diretor: 'John Ford' }
]
```

**üìù Explica√ß√£o**:

1. `$unwind`: Desfaz o array de diretores.
2. `$group`: Agrupa por diretor e conta a quantidade de filmes.
3. `$sort`: Ordena em ordem decrescente.
4. `$limit`: Mostra apenas os 5 primeiros.
5. `$project`: Renomeia o campo `_id` para `diretor`.

### üéØ Exemplo 3: M√©dia de Avalia√ß√£o por Ano

**üí° Objetivo**:
- Calcular a m√©dia de avalia√ß√µes IMDb por ano.

 **‚úÖ Solu√ß√£o:**
```javascript
db.movies.aggregate([
  {
    $match: { "imdb.rating": { $exists: true }, year: { $exists: true } }
  },
  {
    $group: {
      _id: "$year",
      media_avaliacao: { $avg: "$imdb.rating" },
      total_filmes: { $sum: 1 }
    }
  },
  { $sort: { _id: 1 } }
])
```

**Sa√≠da**:
```js
[
  { _id: 1896, media_avaliacao: 5.9, total_filmes: 2 },
  { _id: 1903, media_avaliacao: 7.4, total_filmes: 1 },
  { _id: 1909, media_avaliacao: 6.6, total_filmes: 1 },
  { _id: 1911, media_avaliacao: 7.3, total_filmes: 2 },
  { _id: 1913, media_avaliacao: 6, total_filmes: 1 },
  { _id: 1914, media_avaliacao: 6.8999999999999995, total_filmes: 3 },
  { _id: 1915, media_avaliacao: 6.6, total_filmes: 2 },
  { _id: 1916, media_avaliacao: 6.1, total_filmes: 2 },
  { _id: 1917, media_avaliacao: 6.9, total_filmes: 2 },
  { _id: 1918, media_avaliacao: 6.6, total_filmes: 1 },
  { _id: 1919, media_avaliacao: 7, total_filmes: 1 },
  { _id: 1920, media_avaliacao: 6.9750000000000005, total_filmes: 4 },
  { _id: 1921, media_avaliacao: 7.4, total_filmes: 5 },
  { _id: 1922, media_avaliacao: 7.2, total_filmes: 3 },
  { _id: 1923, media_avaliacao: 7.15, total_filmes: 2 },
  { _id: 1924, media_avaliacao: 7.333333333333333, total_filmes: 6 },
  { _id: 1925, media_avaliacao: 7.3999999999999995, total_filmes: 3 },
  { _id: 1926, media_avaliacao: 7.3500000000000005, total_filmes: 6 },
  { _id: 1927, media_avaliacao: 7.225, total_filmes: 4 },
  { _id: 1928, media_avaliacao: 7.2375, total_filmes: 8 }
]
```

 **üìù Explica√ß√£o**:

1. `$match`: Filtra apenas filmes com avalia√ß√£o e ano definidos.
2. `$group`: Agrupa por ano e calcula m√©dia e contagem.
3. `$sort`: Ordena por ano.

## :five: **Pr√≥ximos Passos**

Se quiser ir al√©m, explore outros est√°gios como:

- `$lookup`: Para realizar joins entre cole√ß√µes.
- `$facet`: Para gerar m√∫ltiplos resultados simultaneamente.
- `$addFields`: Para adicionar novos campos durante o pipeline.

## :six: Exerc√≠cios Propostos

1. Mostre os 10 filmes com a maior dura√ß√£o.
2. Liste os 5 atores com mais filmes na base.
3. Calcule a m√©dia de avalia√ß√µes por g√™nero.
4. Crie um pipeline que mostre a m√©dia de avalia√ß√£o dos filmes lan√ßados ap√≥s 2010.

### ‚úÖ **Exerc√≠cio 1: Mostrar os 10 filmes com a maior dura√ß√£o**

**üéØ Objetivo:**
- Listar os 10 filmes com maior dura√ß√£o.

**‚úÖ Solu√ß√£o:**

```javascript
db.movies.aggregate([
  { $match: { runtime: { $exists: true } } },
  { $sort: { runtime: -1 } },
  { $limit: 10 },
  {
    $project: {
      title: 1,
      year: 1,
      runtime: 1,
      _id: 0
    }
  }
])
```

**Sa√≠da**: 

```js
[
  { runtime: 1256, title: 'Centennial', year: 1978 },
  { runtime: 1140, title: 'Baseball', year: 1994 },
  { runtime: 877, title: 'Taken', year: 2002 },
  { runtime: 780, title: 'Space', year: 1985 },
  { runtime: 720, title: 'Reilly: Ace of Spies', year: 1983 },
  { runtime: 705, title: 'Band of Brothers', year: 2001 },
  { runtime: 680, title: 'The Civil War', year: 1990 },
  { runtime: 680, title: 'The Civil War', year: 1990 },
  { runtime: 600, title: 'The Bible', year: 2013 },
  {
    runtime: 600,
    title: 'New York: A Documentary Film',
    year: '1999√®'
  }
]
```


**üìù Explica√ß√£o Passo a Passo:**

1. **`$match`**: Filtra apenas os filmes que possuem o campo `runtime` definido.
2. **`$sort`**: Ordena os filmes em ordem decrescente (`-1`) pela dura√ß√£o.
3. **`$limit`**: Limita a sa√≠da para os 10 primeiros resultados.
4. **`$project`**: Define quais campos ser√£o exibidos no resultado final (t√≠tulo, ano e dura√ß√£o).


### ‚úÖ **Exerc√≠cio 2: Listar os 5 atores com mais filmes na base**

 **üéØ Objetivo:**
Mostrar os 5 atores que aparecem em mais filmes no banco de dados.

 **‚úÖ Solu√ß√£o:**

```javascript
db.movies.aggregate([
  { $unwind: "$cast" },
  {
    $group: {
      _id: "$cast",
      total_filmes: { $sum: 1 }
    }
  },
  { $sort: { total_filmes: -1 } },
  { $limit: 5 },
  {
    $project: {
      ator: "$_id",
      total_filmes: 1,
      _id: 0
    }
  }
])
```

**Sa√≠da**: 

```js
[
  { total_filmes: 67, ator: 'G√®rard Depardieu' },
  { total_filmes: 58, ator: 'Robert De Niro' },
  { total_filmes: 51, ator: 'Michael Caine' },
  { total_filmes: 49, ator: 'Bruce Willis' },
  { total_filmes: 48, ator: 'Samuel L. Jackson' }
]
```

**üìù Explica√ß√£o Passo a Passo:**

1. **`$unwind`**: Desfaz o array `cast` (atores) para poder agrupar por cada um individualmente.
2. **`$group`**: Agrupa os registros por nome do ator e conta quantos filmes ele participou.
3. **`$sort`**: Ordena os atores pelo n√∫mero de filmes em ordem decrescente.
4. **`$limit`**: Mostra apenas os 5 atores com mais filmes.
5. **`$project`**: Renomeia `_id` para `ator` e inclui a contagem de filmes.


### ‚úÖ **Exerc√≠cio 3: Calcular a m√©dia de avalia√ß√µes por g√™nero**

**üéØ Objetivo:**
- Calcular a m√©dia da avalia√ß√£o IMDb (`imdb.rating`) por g√™nero (`genres`).

### ‚úÖ Solu√ß√£o:

```javascript
db.movies.aggregate([
  { $unwind: "$genres" },
  {
    $group: {
      _id: "$genres",
      media_avaliacao: { $avg: "$imdb.rating" },
      total_filmes: { $sum: 1 }
    }
  },
  { $sort: { media_avaliacao: -1 } },
  { $limit: 10 }
])
```

**Sa√≠da**: 

```js
[
  {
    _id: 'Film-Noir',
    media_avaliacao: 7.397402597402598,
    total_filmes: 77
  },
  {
    _id: 'Short',
    media_avaliacao: 7.377574370709382,
    total_filmes: 442
  },
  {
    _id: 'Documentary',
    media_avaliacao: 7.365679824561403,
    total_filmes: 1834
  },
  { _id: 'News', media_avaliacao: 7.252272727272728, total_filmes: 44 },
  {
    _id: 'History',
    media_avaliacao: 7.1696100917431185,
    total_filmes: 874
  },
  { _id: 'War', media_avaliacao: 7.128591954022989, total_filmes: 699 },
  {
    _id: 'Biography',
    media_avaliacao: 7.087984189723319,
    total_filmes: 1269
  },
  { _id: 'Talk-Show', media_avaliacao: 7, total_filmes: 1 },
  {
    _id: 'Animation',
    media_avaliacao: 6.89669603524229,
    total_filmes: 912
  },
  {
    _id: 'Music',
    media_avaliacao: 6.883333333333334,
    total_filmes: 780
  }
]
```

**üìù Explica√ß√£o Passo a Passo:**

1. **`$unwind`**: Desfaz o array de g√™neros (`genres`) para que cada filme seja associado a um √∫nico g√™nero por vez.
2. **`$group`**:
   - Agrupa por g√™nero (`_id: "$genres"`).
   - Calcula a m√©dia de avalia√ß√£o (`media_avaliacao`).
   - Conta o n√∫mero total de filmes por g√™nero (`total_filmes`).
3. **`$sort`**: Ordena os g√™neros pela m√©dia de avalia√ß√£o em ordem decrescente.
4. **`$limit`**: Limita a sa√≠da para os 10 g√™neros com as melhores m√©dias.

### ‚úÖ **Exerc√≠cio 4: Criar um pipeline que mostre a m√©dia de avalia√ß√£o dos filmes lan√ßados ap√≥s 2010**

**üéØ Objetivo:**
- Calcular a m√©dia de avalia√ß√£o IMDb (`imdb.rating`) dos filmes lan√ßados ap√≥s 2010.

**‚úÖ Solu√ß√£o:**

```javascript
db.movies.aggregate([
  { $match: { year: { $gt: 2010 }, "imdb.rating": { $exists: true } } },
  {
    $group: {
      _id: null,
      media_avaliacao: { $avg: "$imdb.rating" },
      total_filmes: { $sum: 1 }
    }
  }
])
```

**Sa√≠da**: 

```js
[
  { _id: null, media_avaliacao: 6.547932584269663, total_filmes: 4507 }
]
```

**üìù Explica√ß√£o Passo a Passo:**

1. **`$match`**:
   - Filtra apenas filmes com `year > 2010`.
   - Garante que o campo `imdb.rating` exista.
2. **`$group`**:
   - Agrupa todos os documentos (`_id: null`) para calcular a m√©dia global.
   - Calcula a m√©dia de avalia√ß√£o (`media_avaliacao`).
   - Conta o n√∫mero total de filmes nesse per√≠odo (`total_filmes`).

**üß† Dica Adicional**

Para melhorar a performance dos pipelines, √© recomend√°vel:
- Usar `$match` no in√≠cio para reduzir o n√∫mero de documentos processados.
- Evitar usar `$unwind` em arrays muito grandes se n√£o for necess√°rio.
- Utilizar √≠ndices nos campos usados em `$match`, `$sort` e `$group`.

