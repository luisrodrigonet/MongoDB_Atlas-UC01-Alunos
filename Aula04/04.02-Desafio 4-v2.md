# üìò Desafio 4: Consultas e Otimiza√ß√£o com √çndices no MongoDB Atlas
>
> Usando o **MongoDB Atlas**, um servi√ßo de banco de dados NoSQL na nuvem. Vamos criar consultas para responder √†s perguntas abaixo:
> 
> 1. Quais produtos t√™m pre√ßo acima de R$ 100,00?
> 2. Quais clientes realizaram mais de 5 compras?
> 3. Liste apenas os nomes e e-mails dos clientes.
> 
> E, ao final, vamos comparar a performance dessas consultas **antes e depois da cria√ß√£o de √≠ndices**, explicando passo a passo o que √© feito.
> 
> ---


## üìÅ Estrutura do Banco de Dados

Para este desafio, assumimos que temos as seguintes cole√ß√µes (collections):

### Cole√ß√£o `produtos`

```js
db.produtos.find().limit(1)
```

```js
[
  {
    _id: ObjectId('6841a1d41b1d4b0d4246405c'),
    nome: 'Notebook',
    preco: 3500,
    estoque: 10,
    categoria: 'Eletr√¥nicos',
    disponivel: true
  }
]
```

### Cole√ß√£o `clientes`

```js
db.clientes.find().limit(1)
```

```json
{
  "_id": ObjectId("..."),
  "nome": "Jo√£o Silva",
  "email": "joao@example.com",
  "compras": [
    { "produto_id": ObjectId("..."), "data": "2023-01-10" },
    ...
  ]
}
```

> ‚ö†Ô∏è **Importante:** Cada cliente pode ter v√°rias compras armazenadas em um array chamado `compras`.

---

## ‚úÖ Passo 1: Conecte-se ao MongoDB Atlas

1. Acesse [https://cloud.mongodb.com](https://cloud.mongodb.com)
2. Fa√ßa login ou crie uma conta gratuita.
3. Crie um cluster gratuito (se ainda n√£o tiver).
4. Adicione seu IP √† lista de acesso (Network Access).
5. Crie um usu√°rio com permiss√£o de leitura e escrita.
6. Use o **MongoDB Compass** ou o **MongoDB Atlas Data API / Shell** para conectar ao cluster.

---

## üîç Passo 2: Realizando as Consultas

### 1. Quais produtos t√™m pre√ßo acima de R$ 100,00?

**üîé Query:**
```javascript
db.produtos.find({ preco: { $gt: 100 } }).limit(3)
```

**Sa√≠da:**
```js
[
  {
    _id: ObjectId('6841a1d41b1d4b0d4246405c'),
    nome: 'Notebook',
    preco: 3500,
    estoque: 10,
    categoria: 'Eletr√¥nicos',
    disponivel: true
  },
  {
    _id: ObjectId('6841a1fbeb208b7fce50eb70'),
    nome: 'Smartphone',
    preco: 2000,
    estoque: 30,
    categoria: 'Celulares'
  },
  {
    _id: ObjectId('68421294d3326529aa50eb67'),
    nome: 'Notebook',
    preco: 3500,
    categoria: 'Eletr√¥nicos',
    estoque: 10
  }
]
```


**üß† Explica√ß√£o:**
- `db.produtos` ‚Üí acessa a cole√ß√£o chamada `produtos`.
- `.find(...)` ‚Üí m√©todo usado para buscar documentos.
- `{ preco: { $gt: 100 } }` ‚Üí filtro onde o campo `preco` √© maior (`$gt`) que 100.

---

### 2. Quais clientes realizaram mais de 2 compras?

**üîé Query**:
```javascript
db.clientes.find({
  compras: { $exists: true },            // Garante que o campo exista
  $expr: {                               // Permite usar operadores no filtro
    $gt: [ { $size: "$compras" }, 2 ]    // Verifica se o tamanho do array √© maior que 2
  }
}).limit(2)
```

**Sa√≠da:**
```js
[
  {
    _id: '65f5c8e01c9d440000a1b3c0',
    nome: 'Jo√£o Silva',
    email: 'joao.silva@example.com',
    compras: [
      { produto_id: '65f5c8d91c9d440000a1b2c0', data: '2023-09-15' },
      { produto_id: '65f5c8d91c9d440000a1b2c3', data: '2023-10-01' },
      { produto_id: '65f5c8d91c9d440000a1b2c5', data: '2023-10-10' }
    ]
  },
  {
    _id: '65f5c8e01c9d440000a1b3c1',
    nome: 'Maria Oliveira',
    email: 'maria.oliveira@example.com',
    compras: [
      { produto_id: '65f5c8d91c9d440000a1b2c2', data: '2023-08-20' },
      { produto_id: '65f5c8d91c9d440000a1b2c4', data: '2023-09-05' },
      { produto_id: '65f5c8d91c9d440000a1b2c7', data: '2023-09-22' }
    ]
  }
]
```

**üß† Explica√ß√£o**:
- `compras: { $exists: true }` ‚Üí garante que o campo exista.
- `$size: { $gt: 5 }` ‚Üí verifica se o tamanho do array `compras` √© maior que 5.

> üí° Alternativa mais precisa (usando Aggregation):
Se voc√™ quiser contar o n√∫mero real de compras por cliente (por exemplo, considerando apenas compras v√°lidas), use o **Aggregation Pipeline**:


```javascript
db.clientes.aggregate([
  {
    $match: {
      compras: { $exists: true }
    }
  },
  {
    $addFields: {
      totalCompras: { $size: "$compras" }
    }
  },
  {
    $match: {
      totalCompras: { $gt: 2 }
    }
  }
])
```

**Sa√≠da:**
```js
...

  {
    _id: '65f5c8e01c9d440000a1b3d1',
    nome: 'Let√≠cia Mendes',
    email: 'leticia.mendes@example.com',
    compras: [
      { produto_id: '65f5c8d91c9d440000a1b2c6', data: '2023-08-24' },
      { produto_id: '65f5c8d91c9d440000a1b2c7', data: '2023-09-01' },
      { produto_id: '65f5c8d91c9d440000a1b2c8', data: '2023-09-11' }
    ],
    totalCompras: 3
  },
  {
    _id: '65f5c8e01c9d440000a1b3d2',
    nome: 'Felipe Cardoso',
    email: 'felipe.cardoso@example.com',
    compras: [
      { produto_id: '65f5c8d91c9d440000a1b2c0', data: '2023-09-07' },
      { produto_id: '65f5c8d91c9d440000a1b2c2', data: '2023-09-16' },
      { produto_id: '65f5c8d91c9d440000a1b2c9', data: '2023-10-11' }
    ],
    totalCompras: 3
  },
  {
    _id: '65f5c8e01c9d440000a1b3d3',
    nome: 'Bruna Teixeira',
    email: 'bruna.teixeira@example.com',
    compras: [
      { produto_id: '65f5c8d91c9d440000a1b2c3', data: '2023-08-26' },
      { produto_id: '65f5c8d91c9d440000a1b2c4', data: '2023-09-02' },
      { produto_id: '65f5c8d91c9d440000a1b2c5', data: '2023-09-12' }
    ],
    totalCompras: 3
  }
]
```

### 3. Liste apenas os nomes e e-mails dos clientes.

**üîé Query:**
```javascript
db.clientes.find({}, { nome: 1, email: 1, _id: 0 }).limit(4)
```

**Sa√≠da:**
```js
[
  { nome: 'Jo√£o Silva', email: 'joao@email.com' },
  { nome: 'Carlos Pereira', email: 'carlos@email.com' },
  { nome: 'Ana Souza', email: 'ana.souza@email.com' },
  { nome: 'Bruno Costa', email: 'bruno.costa@email.com' }
]
```

**üß† Explica√ß√£o**:
- `{}` ‚Üí sem filtro, retorna todos os documentos.
- `{ nome: 1, email: 1, _id: 0 }` ‚Üí projeta (mostra) apenas os campos `nome` e `email`, e esconde o `_id`.


## üß™ Passo 3: Medindo o Tempo de Execu√ß√£o das Consultas

Para medir o tempo de execu√ß√£o:

### Usando MongoDB Compass:
1. Abra a aba "Performance".
2. Execute suas consultas e observe o tempo retornado.

### Usando MongoDB Shell:

Use o comando `db.currentOp()` , mas no Atlas este comando gera um erro 

```
MongoServerError[AtlasError]: Error validating $currentOp value. arg=allUsers isn't allowed in this atlas tier
```

Ent√£o √© necess√°rio ajusta-lo para

```js
db.adminCommand({
  currentOp: 1,
  ns: "loja.clientes" // substitua por seu banco.cole√ß√£o
})
```

Que gera uma sa√≠da semelhante √†:

```js
{
  inprog: [],
  ok: 1,
  '$clusterTime': {
    clusterTime: Timestamp({ t: 1749164880, i: 11 }),
    signature: {
      hash: Binary.createFromBase64('IA4d40CNfGKL6uHdqkUN7zt1ANA=', 0),
      keyId: Long('7463892594754322439')
    }
  },
  operationTime: Timestamp({ t: 1749164880, i: 11 })
}

```

Ou execute a consulta com timer:

```javascript
const start = new Date();
db.produtos.find({ preco: { $gt: 100 } }).toArray();
const end = new Date() - start;
print(`Tempo: ${end} ms`);
```

**Sa√≠da:**
```js
Tempo: 19 ms
```

---

## üìà Passo 4: Criando √çndices para Otimizar as Consultas

Os √≠ndices s√£o estruturas auxiliares que tornam as buscas mais r√°pidas.

Vamos criar √≠ndices nos campos mais usados nas consultas:

### 1. √çndice no campo `preco` da cole√ß√£o `produtos`:

```javascript
db.produtos.createIndex({ preco: 1 })
```

**Sa√≠da:**
```js
preco_1
```

- `1` ‚Üí ordem ascendente (padr√£o).

### 2. √çndice no campo `compras` da cole√ß√£o `clientes`:

```javascript
db.clientes.createIndex({ "compras.0": 1 })
```

**Sa√≠da:**
```js
compras.0_1
```

- Como `compras` √© um array, indexamos um elemento espec√≠fico (`compras.0`) para garantir que o √≠ndice seja aplicado corretamente.

### 3. √çndice composto nos campos `nome` e `email`:

```javascript
db.clientes.createIndex({ nome: 1, email: 1 })
```

**Sa√≠da:**
```js
nome_1_email_1
```

## üìà Passo 5: Comparando Tempo Antes e Depois dos √çndices

Nesta etapa, vamos **medir o tempo de execu√ß√£o das consultas antes e depois da cria√ß√£o dos √≠ndices**, para verificar a melhoria de desempenho.

O MongoDB n√£o possui um comando embutido como `EXPLAIN ANALYZE` (como em alguns bancos SQL), mas podemos usar:

1. O m√©todo `.explain("executionStats")` para ver detalhes do plano de execu√ß√£o.
1. Um script simples com marca√ß√£o de tempo usando vari√°veis no shell do MongoDB.


Para conseguir realizar os testes precisamos remover os √çndices. Voc√™ pode usar os seguintes comandos no **MongoDB Shell** ou em uma interface como **MongoDB Atlas Compass** ou **drivers de programa√ß√£o**.  

---

### **1. Listar √çndices de uma Cole√ß√£o (`produtos`)**  
```javascript
// Retorna todos os √≠ndices da cole√ß√£o "produtos"
db.produtos.getIndexes();
```
**Sa√≠da:**  
```js
[
  { v: 2, key: { _id: 1 }, name: '_id_' },
  { v: 2, key: { categoria: 1 }, name: 'categoria_1' },
  { v: 2, key: { preco: 1 }, name: 'preco_1' }
]
``` 

### **2. Remover um √çndice Espec√≠fico**  

```javascript
db.produtos.dropIndex("categoria_1");
```

Sa√≠da:

```js
{
  nIndexesWas: 3,
  ok: 1,
  '$clusterTime': {
    clusterTime: Timestamp({ t: 1749210604, i: 4 }),
    signature: {
      hash: Binary.createFromBase64('03T0aSPlgDCjFJZxWfRUHGdtVk8=', 0),
      keyId: Long('7463892594754322439')
    }
  },
  operationTime: Timestamp({ t: 1749210604, i: 4 })
}
```


### **3. Remover Todos os √çndices (exceto o `_id`)** 

Remove todos os √≠ndices, menos o padr√£o (_id)

```javascript
db.produtos.dropIndexes();
```

```js
{
  nIndexesWas: 2,
  msg: 'non-_id indexes dropped for collection',
  ok: 1,
  '$clusterTime': {
    clusterTime: Timestamp({ t: 1749210652, i: 7 }),
    signature: {
      hash: Binary.createFromBase64('2VSjF+S+HBaM2lSQwE+tizyCxx8=', 0),
      keyId: Long('7463892594754322439')
    }
  },
  operationTime: Timestamp({ t: 1749210652, i: 7 })
}
```

**‚ö†Ô∏è Cuidado:** Isso afeta a performance das queries que dependem desses √≠ndices.  


### **4. Listar √çndices de uma Cole√ß√£o (`produtos`)**  
```javascript
// Retorna todos os √≠ndices da cole√ß√£o "produtos"
db.produtos.getIndexes();
```
**Sa√≠da:**  
```js
[ { v: 2, key: { _id: 1 }, name: '_id_' } ]
``` 

**Observa√ß√µes Importantes**  

‚úÖ **No MongoDB Atlas**, voc√™ tamb√©m pode gerenciar √≠ndices pela interface gr√°fica:  
- Acesse **Collections** ‚Üí Selecione a cole√ß√£o ‚Üí Abra a aba **Indexes**.  

‚úÖ **√çndice `_id`** n√£o pode ser removido (√© obrigat√≥rio).  

‚úÖ Use `explain()` para analisar o impacto antes de remover √≠ndices cr√≠ticos.  

## üîß Comandos Usados para medir o tempo

### ‚úÖ 1. Medindo Tempo de Execu√ß√£o com Marca√ß√£o de Tempo

Para medir o tempo de uma consulta em milissegundos, use este padr√£o:

```javascript
const start = new Date(); 

db.produtos.find({ preco: { $gt: 100 } }).toArray();

const end = new Date() - start; 
print(`Tempo de execu√ß√£o: ${end} ms`);
```

**Sa√≠da**:
```
Tempo de execu√ß√£o: 18 ms
```

üí° Este m√©todo for√ßa a execu√ß√£o completa da consulta com `.toArray()` para garantir que todo o resultado seja carregado.


### ‚úÖ 2. Visualizando Estat√≠sticas de Execu√ß√£o com `.explain("executionStats")`

Este comando mostra informa√ß√µes sobre como a consulta foi executada, incluindo o n√∫mero de documentos examinados e o tempo gasto:

```javascript
db.produtos.find({ preco: { $gt: 100 } }).explain("executionStats")
```

#### Exemplo de sa√≠da relevante:
```json
executionStats: {
    executionSuccess: true,
    nReturned: 15,
    executionTimeMillis: 0,
    totalKeysExamined: 0,
    totalDocsExamined: 16,
    executionStages: {
      isCached: false,
      "stage": "COLLSCAN", 
      filter: { preco: { '$gt': 100 } },
      nReturned: 15,
      executionTimeMillisEstimate: 0,
      works: 17,
      advanced: 15,
      needTime: 1,
      needYield: 0,
      saveState: 0,
      restoreState: 0,
      isEOF: 1,
      direction: 'forward',
      docsExamined: 16
    }
  },
```

Depois de criar o √≠ndice, voc√™ deve ver algo assim:

```json
"executionStages": {
  "stage": "IXSCAN",  // Indica uso de √≠ndice
  ...
}
```

### ‚úÖ 4. Exemplo de Compara√ß√£o

#### Antes da Indexa√ß√£o

```javascript
const start = new Date();
db.produtos.find({ preco: { $gt: 100 } }).toArray();
const end = new Date() - start;
print(`Tempo antes do √≠ndice: ${end} ms`);
```

- Tempo antes do √≠ndice: 18 ms


#### Criando os √çndices 

```js
db.produtos.getIndexes();
```

```js
[ { v: 2, key: { _id: 1 }, name: '_id_' } ]
```


```javascript
db.produtos.createIndex({ preco: 1 })
```

```js
preco_1
```

```js
db.produtos.getIndexes();
```

```js
[
  { v: 2, key: { _id: 1 }, name: '_id_' },
  { v: 2, key: { preco: 1 }, name: 'preco_1' }
]
```

#### Depois da Indexa√ß√£o

```javascript
const start = new Date();
db.produtos.find({ preco: { $gt: 100 } }).toArray();
const end = new Date() - start;
print(`Tempo ap√≥s o √≠ndice: ${end} ms`);
```

- Tempo ap√≥s o √≠ndice: 19 ms

## üìö Gloss√°rio R√°pido

| Termo             | Significado                                                                 |
|------------------|-----------------------------------------------------------------------------|
| `$gt`            | Operador de compara√ß√£o "maior que"                                         |
| `$size`          | Retorna o tamanho de um array                                              |
| `createIndex`    | Cria um √≠ndice em um campo para otimizar consultas                          |
| `$addFields`     | Adiciona novos campos durante o pipeline                                   |
| `$match`         | Filtra documentos dentro do pipeline                                       |
| Projection       | Define quais campos mostrar ou ocultar                                     |



