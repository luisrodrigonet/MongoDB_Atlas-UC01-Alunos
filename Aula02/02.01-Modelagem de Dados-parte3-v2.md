# Aula: Introdu√ß√£o √† Modelagem de Dados no MongoDB Atlas

> ## Objetivo da Aula
> 
> Esta aula tem como objetivo introduzir os conceitos b√°sicos de modelagem de dados em bancos NoSQL, especificamente no MongoDB. Ser√° abordada a diferen√ßa entre bancos relacionais e NoSQL, estrutura de documentos JSON, princ√≠pios de modelagem no MongoDB e, por fim, um exemplo pr√°tico de modelagem para um sistema de biblioteca.
> 
> ---
>


## :five: Trabalhando com o Banco de Dados `sample_mflix`

O MongoDB disponibiliza uma base de dados p√∫blica chamada **`sample_mflix`**, contendo informa√ß√µes sobre filmes, diretores, elencos e coment√°rios dos usu√°rios.

### Cole√ß√µes Dispon√≠veis no `sample_mflix`:

| Cole√ß√£o         | Descri√ß√£o                             |
|------------------|----------------------------------------|
| `movies`         | Informa√ß√µes sobre filmes               |
| `comments`       | Coment√°rios feitos por usu√°rios        |
| `theaters`       | Informa√ß√µes sobre cinemas              |
| `users`          | Dados de usu√°rios do sistema           |


> OBS: Para executar os comandos apresentados nos exemplos a seguir √© necess√°rio estar conectado ao Cluster criando no MongoDB Atlas na aula anterior. A conex√£o pode ser realizada via linha de comando utilizando o `mongodbsh`, ou utilizando a aplica√ß√£o gr√°fica `MondoDB Compass`


![drawing](img/001-mongodb-compass-001.png){ width=75% style="display: block; margin: 0 auto"}

![drawing](img/002-mongodb-compass-002.png){ width=75% style="display: block; margin: 0 auto"}

![drawing](img/003-mongodb-compass-003.png){ width=75% style="display: block; margin: 0 auto"}

### üß™ Exemplo 1: Consultar Filmes com Detalhes

A cole√ß√£o `movies` possui documentos com informa√ß√µes completas sobre filmes.

**Exemplo de Documento:**

```json
{
  "_id": ObjectId("573a1390f6d9cbb1e75bdc52"),
  "title": "The Dark Knight",
  "year": 2008,
  "plot": "When the menace of the Joker wreaks havoc on the people of Gotham...",
  "genres": ["Action", "Crime", "Drama"],
  "runtime": 152,
  "cast": ["Christian Bale", "Heath Ledger", "Aaron Eckhart"],
  "directors": ["Christopher Nolan"],
  "imdb": {
    "rating": 9.0,
    "votes": 2460000
  },
  "tomatoes": {
    "viewer": { "rating": 9.2, "numReviews": 2500 }
  }
}
```

**Consulta Simples:**

```javascript
use sample_mflix
db.movies.find({ title: "The Dark Knight" }, { title: 1, year: 1, genres: 1 }).pretty()
```

**Sa√≠da:**

```js
{
  _id: ObjectId('573a13b5f29313caabd42722'),
  year: 2008,
  genres: [
    'Action',
    'Crime',
    'Drama'
  ],
  title: 'The Dark Knight'
}
```

### üß™ Exemplo 2: Relacionamento entre Cole√ß√µes (Filmes e Coment√°rios)

A cole√ß√£o `comments` tem uma refer√™ncia ao filme atrav√©s do campo `movie_id`.

**Estrutura do Documento na Cole√ß√£o `comments`:**

```json
{
  "_id": ObjectId("..."),
  "name": "Maria Silva",
  "email": "maria@email.com",
  "text": "Adorei esse filme!",
  "movie_id": ObjectId("573a1390f6d9cbb1e75bdc52")
}
```

**Consultar Coment√°rios de Um Filme:**

```javascript
// Primeiro, obter o _id do filme
var movie = db.movies.findOne({ title: "The Dark Knight" });

// Agora buscar todos os coment√°rios desse filme
db.comments.find({ movie_id: movie._id }, { name: 1, text: 1, _id: 0 });
```

**Sa√≠da**

```js
{
  name: 'Andrea Le',
  text: 'Vitae repellat autem magni quo modi illum sapiente necessitatibus. Ullam molestiae dignissimos dignissimos maxime dolores maxime repudiandae. Vitae laboriosam aliquid eum.'
}
{
  name: 'Alliser Thorne',
  text: 'Ducimus possimus similique id cumque distinctio. Voluptates rerum ipsa dicta numquam ipsa qui eos. Ab ea modi in eaque. Maxime asperiores deleniti unde vitae qui.'
}
{
  name: 'Amy Ramirez',
  text: 'Commodi et voluptates incidunt. Optio reiciendis beatae ducimus accusantium perferendis veritatis. Iure numquam rerum voluptas omnis quasi vitae. Ab praesentium vero magni placeat totam placeat.'
}

... Continua ...

```


### üß™ Exemplo 3: Usar Agrega√ß√£o para Contar Coment√°rios por Filme

Podemos usar o est√°gio `$lookup` para fazer algo semelhante a um `JOIN` entre cole√ß√µes.

```javascript
db.movies.aggregate([
  {
    $match: { title: "The Dark Knight" }
  },
  {
    $lookup: {
      from: "comments",
      localField: "_id",
      foreignField: "movie_id",
      as: "comentarios"
    }
  },
  {
    $project: {
      title: 1,
      comentarios_count: { $size: "$comentarios" },
      _id: 0
    }
  }
]);
```

**Explica√ß√£o** 

- O m√©todo **aggregate()** permite encadear v√°rias etapas (stages) que transformam os dados. Cada etapa √© um objeto dentro de um array.

- **$match** ‚Äì Filtrar documentos por t√≠tulo, age como um filtro inicial, semelhante ao WHERE em SQL. Isso reduz o n√∫mero de documentos que passam para as pr√≥ximas etapas ‚Äî importante para performance.

- **$lookup** ‚Äì Simular um JOIN entre cole√ß√µes, realiza uma opera√ß√£o de jun√ß√£o entre duas cole√ß√µes : movies e comments.

    - from : Cole√ß√£o com a qual queremos fazer a jun√ß√£o ‚Üí comments
    - localField: Campo na cole√ß√£o atual ( movies ) usado para combinar ‚Üí _id
    - foreignField: Campo na cole√ß√£o comments que referencia o filme ‚Üí movie_id
    - as: Nome do novo campo que ser√° criado no documento com os resultados da jun√ß√£o ‚Üí comentarios

- O resultado incluir√° um novo campo chamado "comentarios" contendo todos os coment√°rios relacionados ao filme "The Dark Knight".

- **$project** ‚Äì Selecionar campos espec√≠ficos no resultado - Define quais campos ser√£o mostrados no resultado final.
    - title: 1 - Inclui o campo title no resultado
    - comentarios_count: { $size: "$comentarios" } - Cria um novo campo que conta quantos elementos h√° no array comentarios
    - _id: 0 - Exclui o campo _id do resultado

- O operador **$size** retorna o n√∫mero de elementos em um array. 

**üí° Resultado esperado:**

```json
{
  "title": "The Dark Knight",
  "comentarios_count": 136
}
```

Este pipeline √© muito √∫til quando voc√™ precisa juntar informa√ß√µes de diferentes cole√ß√µes e mostrar apenas os dados mais relevantes , otimizando a leitura e facilitando a apresenta√ß√£o dos dados na sua aplica√ß√£o.



### üìö Exerc√≠cio Proposto

#### Tarefa: Encontre os 5 filmes com melhor avalia√ß√£o do IMDb

**Passos:**
1. Use a cole√ß√£o `movies`.
2. Ordene pela nota `imdb.rating` em ordem decrescente.
3. Projete apenas t√≠tulo, ano e rating.
4. Limite a 5 resultados.

**Comando - Original:**

```javascript
db.movies.find(
  { "imdb.rating": { $exists: true } },
  { title: 1, year: 1, "imdb.rating": 1, _id: 0 }
)
  .sort({ "imdb.rating": -1 })
  .limit(5)
  .pretty();
```

**Comando - Corrigido:**

```js
db.movies.find(
  {
    "imdb.rating": {
      $exists: true,
      $ne: null,
      $ne: ""
    }
  },
  {
    title: 1,
    year: 1,
    "imdb.rating": 1,
    _id: 0
  }
)
  .sort({ "imdb.rating": -1 })
  .limit(5)
  .pretty();
```

**Explica√ß√£o**

- Filtro (find)
    - $exists: garante que o campo esteja presente no documento.
    - $ne: significa not equal (diferente), ent√£o exclu√≠mos valores inv√°lidos.
-  Proje√ß√£o (projection)
    - Define quais campos ser√£o mostrados (1 = incluir, 0 = excluir).
    - Exclu√≠mos _id para deixar o resultado mais limpo.
- Ordena√ß√£o (sort)
    - `-1` significa ordena√ß√£o decrescente , do maior para o menor rating.
- Limita√ß√£o (limit)
    - Limita o resultado aos 5 primeiros filmes da lista.
- Formata√ß√£o (pretty)
    - Melhora a legibilidade do resultado no terminal.

**üí° Dica Extra ‚Äì Indexar para Performance**

Se voc√™ rodar essa consulta com frequ√™ncia, pode melhorar a performance criando um √≠ndice:

```js
db.movies.createIndex({ "imdb.rating": -1 });
```

Isso acelera a ordena√ß√£o e filtros baseados na nota do IMDb.

